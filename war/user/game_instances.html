<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- The HTML 4.01 Transitional DOCTYPE declaration-->
<!-- above set at the top of the file will set     -->
<!-- the browser's rendering engine into           -->
<!-- "Quirks Mode". Replacing this declaration     -->
<!-- with a "Standards Mode" doctype is supported, -->
<!-- but may lead to some differences in layout.   -->

<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>User Game Instances</title>
    
    <script type = "text/javascript" src="../resources/jquery-1.4.2.min.js"></script>
    <script type = "text/javascript" src="../resources/jquery.json-2.2.min.js"></script>
    <script type="text/javascript">
    	// editing a game template?
    	var current_game_template = null;
    	var game_template_id = null;
    	// start here...
    	$.ajaxSetup({cache:false});

    	function format(text,len) {
        	var str = String(text);
        	while (str.length<2) 
            	str = '0'+str;
        	return str;
    	}
		function prettyTimeToString(time) {
			if (time==0)
				return "Unspecified";
			var date = new Date(time);
			// TZ?
			var str = format(date.getUTCFullYear(),4)+'-'+format(date.getUTCMonth()+1,2)+'-'+format(date.getUTCDate(),2)+' '+
			format(date.getUTCHours(),2)+':'+format(date.getUTCMinutes(),2)+':'+format(date.getUTCSeconds(),2);
			if (date.getTimezoneOffset()!=0)
				str = str+' Z ('+date.getTimezoneOffset()+')';
				//date.toUTCString();
			return str;
		}
		function timeToString(time) {
			var date = new Date(time);
			var str = format(date.getUTCFullYear(),4)+format(date.getUTCMonth()+1,2)+format(date.getUTCDate(),2)+'T'+
			format(date.getUTCHours(),2)+format(date.getUTCMinutes(),2)+format(date.getUTCSeconds(),2)+'Z';
			return str;
		}
		function stringToTime(str) {
			var date = new Date(0);
			var match = /\d\d\d\d\d\d\d\d[T]\d\d\d\d\d\d[Z]/ .exec(str);
			if (match==null) 
				alert('Unable to parse time '+str);
			else {
				date.setUTCFullYear(str.substr(0,4));
				date.setUTCMonth(Number(str.substr(4,2))-1);
				date.setUTCDate(str.substr(6,2));
				date.setUTCHours(str.substr(9,2));
				date.setUTCMinutes(str.substr(11,2));
				date.setUTCSeconds(str.substr(13,2));
			}
			return date.getTime();				
		}
    	
    	function get_templates() {
        	// loading...
       	    $('#templates_status').remove();
    	    $('.game_template').remove();
    		$('<tr id="templates_status"><td>Loading data...</td></tr>').appendTo('#templates');
        	$.getJSON('GetUserGameInstances/'+game_template_id,function(json) {
        	    $('#templates_status').remove();
        	    var item;
				for (item in json) {
					// this is so... weird - acct initially seems to be array index
					if (!$.isPlainObject(item))
						item = json[item];
					//<td>title</td><td >game server id</td><td>start time</td><td>end time</td><td>latitude(E6)</td><td>longitude(E6)</td><td>radius (metres)</td><td>status</td><td>base url</td>
		        	$('<tr class="game_template"><td>'+item.title+'</td><td>'+timeToString(item.startTime)+'</td><td>'+timeToString(item.endTime)+'</td><td>'+item.latitudeE6+'</td><td>'+item.longitudeE6+'</td><td>'+item.radiusMetres+'</td><td>'+item.nominalStatus+'</td><td>'+item.baseUrl+'</td><!-- <td>'+item.gameServerId+'</td> --><td><input type="button" value="edit" onclick="select_template(\''+item.key+'\')"/></td></tr>').appendTo('#templates');
				}
        	});
    	}

    	function get_template_options() {
        	// loading...
       	    $('select[name=gameTemplateId] > option').remove();
       	    $('select[name=gameTemplateId]').append('<option label="Loading..." selected="true"/>');
        	$.getJSON('GetUserGameTemplates',function(json) {
           	    $('select[name=gameTemplateId] > option').remove();
           	    //alert('got '+json.length+' template options: '+json);
                $('select[name=gameTemplateId]').append('<option label="Select an option..." value="" selected/>Select an option...</option>');
        	    for (var i=0; i<json.length; i++) {
            	    var item = json[i];
               	    $('select[name=gameTemplateId]').append('<option label="'+item.title+'" value="'+item.id+'"/>'+item.title+'</option>');
               	}
        	});
    	}

    	var game_servers = null;
    	function select_game_server(i) {
			//alert('select game server '+i+', and '+game_servers.length+' servers');
			//+': '+game_servers[i].baseUrl);
			if (i>=0 && game_servers!=null && i<game_servers.length) {
            	$(':input[name=baseUrl]').attr('value',game_servers[i].baseUrl);				
			}
    	}
    	function update_game_server_id() {
        	var game_server_index = $('select[name=gameServerId] > option[selected]').index()-1;
        	select_game_server(game_server_index);
        }
    	function get_server_options() {
        	// loading...
       	    $('select[name=gameServerId] > option').remove();
       	    $('select[name=gameServerId]').append('<option label="Loading..." selected="true"/>');
        	$.getJSON('GetUserGameServers',function(json) {
            	game_servers = json;
           	    $('select[name=gameServerId] > option').remove();
           	    $('select[name=gameServerId]').append('<option label="Unspecified" value=""/>');
           	    //alert('got '+json.length+' game server template options: '+json);
        	    for (var i=0; i<json.length; i++) {
            	    var item = json[i];
            	    //alert('item '+i+'='+item);
               	    $('select[name=gameServerId]').append('<option label="'+item.title+' ('+item.type+')" value="'+item.key+'"/>'+item.title+' ('+item.type+')</option>');
               	}
        	});
    	}

    	$(document).ready(function() {
        	//get_templates();
        	get_template_options();
        	get_server_options();
    	});

    	function add_field(form, obj, name, input_name) {
        	if (!input_name)
            	input_name = name;
        	var value = $(':input[name='+input_name+']',form).attr('value');
        	if (value!=null && value!='')
            	obj[name] = value;
    	}
    	function add_time_field(form, obj, name, input_name) {
        	if (!input_name)
            	input_name = name;
        	var value = $(':input[name='+input_name+']',form).attr('value');
        	if (value!=null && value!='')
            	obj[name] = stringToTime(value);
    	}
    	function add_number_field(form, obj, name, input_name) {
        	if (!input_name)
            	input_name = name;
        	var value = $(':input[name='+input_name+']',form).attr('value');
        	if (value!=null && value!='')
            	obj[name] = Number(value);
    	}
    	function add_select_field(form, obj, name, input_name) {
        	if (!input_name)
            	input_name = name;
        	var value = $('select[name='+name+'] > option[selected]').attr('value');
        	if (value!=null && value!='')
            	obj[name] = value;
    	}
    	// called from form submit for add template
    	function add_game_template(form) {
        	var gt = {};
        	add_select_field(form, gt, 'gameServerId');
        	add_field(form, gt, 'title');
        	gt.gameTemplateId = game_template_id;
        	add_field(form, gt, 'baseUrl');
        	//add_field(form, gt, 'status');
        	add_select_field(form, gt, 'nominalStatus');
        	add_time_field(form, gt, 'startTime');
        	add_time_field(form, gt, 'endTime');
        	add_number_field(form, gt, 'latitudeE6');
        	add_number_field(form, gt, 'longitudeE6');
        	add_number_field(form, gt, 'radiusMetres');

    		var data = $.toJSON(gt);
    		//alert('Request: '+data);
    		if (current_game_template==null) {
	    		$.ajax({url: 'AddGameInstance', 
	        		type: 'POST',
	        		contentType: 'application/json',
	        		processData: false,
	        		data: data,
	        		dataType: 'text',
	        		success: function success(data, status) {
	        			get_templates();
	        			alert('Added instance ('+status+')');
	    			},
	    			error: function error(req, status) {
	        			alert('Error adding instance ('+req.status+': '+req.statusText+')');
	    			}
	    		});
    		} else {
        		// edit
	    		$.ajax({url: 'UserGameInstance/'+current_game_template.key, 
	        		type: 'POST',
	        		contentType: 'application/json',
	        		processData: false,
	        		data: data,
	        		dataType: 'text',
	        		success: function success(data, status) {
	        			get_templates();
	        			alert('Updated instance ('+status+')');
	    			},
	    			error: function error(req, status) {
	        			alert('Error updating instance ('+req.status+': '+req.statusText+')');
	    			}
	    		});
    		}    	
        	//alert('add '+$.toJSON(gt));
        	return false;
    	}
    	// reset game template form to add 
    	function reset_game_template(form) {
        	current_game_template = null;
        	$(':input[type=submit]').attr('value','Add game instance');
        	return true;
    	}
    	// reset game template form to add 
    	function select_template(id) {
        	//alert('select template '+id);
        	current_game_template = null;
        	$(':input[type=submit]').attr('value','Update game instance');
        	$(':input[name=key]').attr('value',id);
        	$(':input[name=title]').attr('value','Loading data...');
        	$.getJSON('UserGameInstance/'+id, function(data) {
            	//alert('received '+$.toJSON(data));
            	current_game_template = data;
            	$(':input[name=title]').attr('value',data.title);
				$('select[name=gameServerId] > option[selected]').removeAttr('selected');
				if (data.gameServerId!=null && data.gameServerId!='')
					$('select[name=gameServerId] > option[value='+data.gameServerId+']').attr('selected','true');
            	$(':input[name=startTime]').attr('value',timeToString(data.startTime));
            	$(':input[name=endTime]').attr('value',timeToString(data.endTime));
            	$(':input[name=latitudeE6]').attr('value',data.latitudeE6);
            	$(':input[name=longitudeE6]').attr('value',data.longitudeE6);
            	$(':input[name=radiusMetres]').attr('value',data.radiusMetres);
            	//$(':input[name=status]').attr('value',data.status);
				$('select[name=nominalStatus] > option[selected]').removeAttr('selected');
				if (data.nominalStatus!=null && data.nominalStatus!='')
					$('select[name=nominalStatus] > option[value='+data.nominalStatus+']').attr('selected','true');
            	$(':input[name=baseUrl]').attr('value',data.baseUrl);
        	});
        	return false;
    	}
    	function update_game_template_id() {
        	game_template_id = $('select[name=gameTemplateId] > option[selected]').attr('value');
        	if (game_template_id!=null && game_template_id.length>0)
	        	get_templates();
    	}
    </script>
  </head>

  <body>
    <h1>User Game Instances</h1>
    
    <p>Time: 
    <script>
    	var now = new Date().getTime();
    	document.write(now+' = '+prettyTimeToString(now)+', '+timeToString(now))
    </script>
    </p>
    
    <h2>Game Template</h2>
    
    <select name="gameTemplateId" onchange="update_game_template_id()">
	</select>
    
    <h2>Current Instances</h2>
    <table id="templates" border="1">
      <tr style="font-weight:bold;">
        <td>title</td><td>start time</td><td>end time</td><td>latitude(E6)</td><td>longitude(E6)</td><td>radius (metres)</td><td>nominal status</td><td>base url</td><!-- <td >game server id</td> -->
      </tr>
      <tr id="templates_status">
        <td>Select template...</td>        
      </tr>
    </table>
	<p><input type="button" value="Refresh" onclick="get_templates()"/></p>
	
	<h2>Game Instance</h2>
	<form action="dummy" onsubmit="return add_game_template(this)">
		<table border="1">
			<tr><td>key</td><td><input type="text" name="key" readonly="readonly"/></td></tr>
			<tr><td>title</td><td><input type="text" name="title"/></td></tr>
			<tr><td>game server id</td><td>
			    <select name="gameServerId" onchange="update_game_server_id()">
				</select>	
			</td></tr>
			<tr><td>start time</td><td><input type="text" name="startTime" value="19700101T000000Z"/></td></tr>
			<tr><td>end time</td><td><input type="text" name="endTime" value="19700101T000000Z"/></td></tr>
			<tr><td>latitude (E6)</td><td><input type="text" name="latitudeE6"/></td></tr>
			<tr><td>longitude (E6)</td><td><input type="text" name="longitudeE6"/></td></tr>
			<tr><td>radius (metres)</td><td><input type="text" name="radiusMetres"/></td></tr>
			<tr><td>nominal status</td><td>
				<!-- <input type="text" name="nominalStatus"/>  -->
				<select name="nominalStatus">
					<option label="Unspecified" value="" selected="true"></option>
					<option label="POSSIBLE" value="POSSIBLE">POSSIBLE</option>
					<option label="PLANNED" value="PLANNED">PLANNED</option>
					<option label="AVAILABLE" value="AVAILABLE">AVAILABLE</option>
					<option label="ENDED" value="ENDED">ENDED</option>
					<option label="TEMPORARILY_UNAVAILABLE" value="TEMPORARILY_UNAVAILABLE">TEMPORARILY_UNAVAILABLE</option>
					<option label="ENDED" value="ENDED">ENDED</option>
				</select>  
			</td></tr>
			<tr><td>base url</td><td><input type="text" name="baseUrl"/></td></tr>
		</table>
		<p><input type="submit" value="Add game instance"/><input type="reset" value="Reset/New" onclick="reset_game_template(this)"/></p>
	</form>
  </body>
</html>
